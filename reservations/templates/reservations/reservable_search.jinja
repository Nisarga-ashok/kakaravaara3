{% extends "shoop/front/base.jinja" %}


{% block content_title %}
    {% trans %}Reservations{% endtrans %}
{% endblock %}


{% block content %}
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-6">
                <p>
                    {% trans %}Select months to search from{% endtrans %}
                </p>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label for="from_month">{% trans %}Starting month{% endtrans %}</label>
                    <input name="from" id="from_month" class="form_datetime form-control" size="16" type="text" placeholder="{% trans %}mm/yyyy{% endtrans %}" value="{{ start_month }}">
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label for="to_month">{% trans %}End month{% endtrans %}</label>
                    <input name="to" id="to_month" class="form_datetime form-control" size="16" type="text" placeholder="{% trans %}mm/yyyy{% endtrans %}" value="{{ end_month }}">
                </div>
            </div>
        </div>

        <script type="text/javascript">
            var dates = {{ reserved_days|safe }};
            $(window).ready(function() {
                $("#from_month").datetimepicker({
                    format: "mm/yyyy",
                    weekStart: 1,
                    autoclose: true,
                    startView: "year",
                    minView: "year",
                    language: "fi",
                    initialDate: moment.tz("{{ start_date }}", "Europe/Helsinki"),
                    startDate: moment().startOf("month").tz("Europe/Helsinki").toDate()
                });
                $("#to_month").datetimepicker({
                    format: "mm/yyyy",
                    weekStart: 1,
                    autoclose: true,
                    startView: "year",
                    minView: "year",
                    language: "fi",
                    initialDate: moment.tz("{{ end_date }}", "Europe/Helsinki"),
                    startDate: moment().startOf("month").tz("Europe/Helsinki").toDate()
                }).change(function() {
                    $("body").addClass("loading");
                    var from = $("#from_month").val();
                    var to = $("#to_month").val();
                    window.location = '{{ url("reservations:reservable.search") }}?start='+moment(from, "MM/YYYY").format("YYYY-MM-DD")+'&end='+moment(to, "MM/YYYY").format("YYYY-MM-DD");
                });
            });
        </script>

        <div class="row" style="margin-top: 20px;">
            <div class="col-md-12">
                <p>
                    {% trans %}Cottages and their reserved periods.{% endtrans %}
                </p>
                <p>
                   {% trans %}To reserve a cottage, click on a free date in the calendar, type in the number of days and click 'Reserve'.{% endtrans %}
                </p>
            </div>
        </div>

        {% for reservable in reservables %}
            {% set sku = reservable.product.sku|replace("-", "_") %}
            <hr>
            <div class="row" style="margin-top: 20px;">
                <div class="col-md-6">
                    <div id="reservables">
                        <div class="pull-left" style="width: 140px;">
                            <div class="text-center" style="padding-left: 5px;">
                                <h3 style="margin-top: 0px;">{{ reservable.product.name }}</h3>
                            </div>
                            <div class="text-center" style="border: solid 1px; width:140px; height: 140px; margin: 0px 5px; border-radius: 3px; cursor: pointer;">
                                <a href="{{ url("shoop:product", pk=reservable.product.id, slug=reservable.product.slug) }}">
                                    {% if reservable.product.primary_image %}
                                        <img src="{{ reservable.product.primary_image|thumbnail(size=(140, 140), crop="smart", upscale=True)}}" class="img-responsive" alt="{{ reservable.product.name }}">
                                    {% else %}
                                        <i style="font-size-adjust: 2.7; padding-top: 65px; padding-right: 5px;" class="glyphicon glyphicon-home"></i>
                                    {% endif %}
                                </a>
                            </div>
                        </div>
                        <div class="pull-left" style="margin-top: 21px;">
                            <dl class="dl-horizontal">
                                {% for attribute in reservable.product.attributes.all() %}
                                    {% if attribute.attribute.identifier in visible_attributes %}
                                        <dt>{{ attribute.name }}</dt>
                                        <dd>{{ attribute.formatted_value }}</dd>
                                    {% endif %}
                                {% endfor %}
                            </dl>
                        </div>
                        <div class="clearfix"></div>
                        <div class="hidden text-center reservation-control">
                            <form role="form" method="post" action="{{ url("shoop:basket") }}">
                                <input type="hidden" name="return" value="{{ request.path }}">
                                <input type="hidden" name="command" value="add">
                                <input type="hidden" name="product_id" value="{{ reservable.product.id }}">
                                <div class="form-group">
                                    <label for="{{ sku }}-start">{% trans %}Arrival Date{% endtrans %}</label>
                                    <input class="form-control" name="reservation_start" type="date" id="{{ sku }}-start">
                                </div>
                                <div class="form-group">
                                    <label for="{{ sku }}-days">{% trans %}Number of nights{% endtrans %}</label>
                                    <input class="form-control" name="quantity" type="number" value="1" id="{{ sku }}-days" min="1">
                                </div>
                                <div class="form-group pull-left" style="width: 40%;">
                                    <label for="{{ sku }}-adults">{% trans %}Adults{% endtrans %}</label>
                                    <input class="form-control" name="adults" type="number" value="1" id="{{ sku }}-adults" min="1">
                                </div>
                                <div class="form-group pull-right" style="width: 40%;">
                                    <label for="{{ sku }}-children">{% trans %}Children{% endtrans %}</label>
                                    <input class="form-control" name="children" type="number" value="0" id="{{ sku }}-children" min="0">
                                </div>
                                <div class="text-info" style="display: inline-block;">
                                    <p>{% trans %}The number of adults and children is needed to provide bedding.{% endtrans %}</p>
                                </div>
                                <div id="{{ sku }}-error-container" class="text-center hidden">
                                    <p class="text-danger">{% trans %}Chosen period is not available.{% endtrans %}</p>
                                </div>
                                <button id="{{ sku }}-submit" type="submit" class="btn btn-primary btn-block">{% trans %}Reserve{% endtrans %}</button>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    {% for month in months %}
                        <div style="display: inline-block;" id="reservable-dates-{{ sku }}-{{ month }}"></div>
                        <script>
                            $(document).ready(function() {
                                var reservedDates = [];
                                for (var i=0; i<dates.{{ sku }}.length; i++) {
                                    reservedDates.push(new Date(dates.{{ sku }}[i]));
                                }
                                $("#reservable-dates-{{ sku }}-{{ month }}").datetimepicker({
                                    startView: 2,
                                    language: 'fi',
                                    minView: 2,
                                    format: 'dd.mm.yyyy',
                                    weekStart: 1,
                                    maxView: 3,
                                    clearBtn: false,
                                    initialDate: '{{ month }}',
                                    specialDates: [
                                        {
                                            className: "reserved",
                                            dates: reservedDates
                                        }
                                    ],
                                    datesHaveData: true
                                });
                                $("#reservable-dates-{{ sku }}-{{ month }} .datetimepicker td").removeClass("active");
                                $("#reservable-dates-{{ sku }}-{{ month }} .datetimepicker").off("click");
                                $("#reservable-dates-{{ sku }}-{{ month }} .day:not('.reserved')").click(function (ev) {
                                    // Transfer start date to correct input and show the form
                                    var t = $(ev.currentTarget);
                                    $("#{{ sku }}-start").val(t.data("date"));
                                    $("#{{ sku }}-start").closest(".reservation-control").removeClass("hidden");
                                    $("#{{ sku }}-days").trigger("change");
                                });
                            });
                        </script>
                    {% endfor %}
                    <script>
                        $(document).ready(function() {
                            function set{{ sku }}Button(status) {
                                $("#{{ sku }}-submit").prop("disabled", status);
                            }

                            function set{{ sku }}Error(status) {
                                if (status)
                                    $("#{{ sku }}-error-container").removeClass("hidden");
                                else
                                    $("#{{ sku }}-error-container").addClass("hidden");
                            }

                            function check{{ sku }}Period() {
                                // Lookup backend to see if new range is free
                                if ($("#{{ sku }}-days").val() <= 0) {
                                    set{{ sku }}Button(true);
                                } else {
                                    $.getJSON(
                                        '{{ url("reservations:check_period") }}?reservable_id={{ reservable.id }}&start=' + $("#{{ sku }}-start").val() + '&days=' + $("#{{ sku }}-days").val(),
                                        function (data) {
                                            if (data && data.result === true) {
                                                set{{ sku }}Button(false);
                                                set{{ sku }}Error(false);
                                            } else {
                                                set{{ sku }}Button(true);
                                                set{{ sku }}Error(true);
                                            }
                                        }
                                    ).fail(function () {
                                        set{{ sku }}Button(true);
                                    });
                                }
                            }
                            $("#{{ sku }}-days").change(check{{ sku }}Period);
                            $("#{{ sku }}-days").keyup(check{{ sku }}Period);
                        });
                    </script>
                </div>
            </div>
        {% endfor %}
    </div>
    <div class="modal spinner"></div>
{% endblock %}


{% block extrameta %}
    <!-- Moment.js -->
    <script type="text/javascript" src="{{ static("js/moment-with-locales.min.js") }}"></script>
    <script type="text/javascript" src="{{ static("js/moment-timezone-with-data.min.js") }}"></script>

    <!-- Include Datetimepicker -->
    <script type="text/javascript" src="{{ static("js/bootstrap-datetimepicker.js") }}"></script>
    <script type="text/javascript" src="{{ static("js/locales/bootstrap-datetimepicker.fi.js") }}"></script>
    <link rel="stylesheet" type="text/css" href="{{ static("css/bootstrap-datetimepicker.min.css") }}" />
    <link rel="stylesheet" type="text/css" href="{{ static("css/reservations.css") }}" />
{% endblock %}
